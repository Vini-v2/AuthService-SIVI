{"version":3,"sources":["webpack:///webpack/bootstrap 24b2f2760a0224e3ff9a","webpack:///external \"dotenv\"","webpack:///external \"mongoose\"","webpack:///./src/index.js","webpack:///external \"koa\"","webpack:///external \"koa-morgan\"","webpack:///external \"koa-helmet\"","webpack:///external \"koa-bodyparser\"","webpack:///./src/router.js","webpack:///external \"koa-router\"","webpack:///./src/UserController/index.js","webpack:///./src/UserController/dbUtils.js","webpack:///./src/UserController/UserSchema.js","webpack:///external \"bcrypt\"","webpack:///external \"mongoose-beautiful-unique-validation\"","webpack:///./src/UserController/jwt.js","webpack:///external \"jsonwebtoken\"","webpack:///external \"bluebird\""],"names":["env","config","APP_PORT","process","app","use","bodyParser","extendTypes","json","onerror","err","ctx","console","error","request","body","throw","router","routes","allowedMethods","helmet","logger","listen","log","service","name","version","msg","APP_MAIN_ROUTS_PREFIX","UserSugnIn","UserSugnUp","TokenСheck","prefix","get","next","status","post","user","JWT","errors","db","connect","result","addUser","authorization","headers","match","Token","replace","query","refresh","newJWT","refreshUserToken","login","CheckJWT","DB_HOST","DB_PORT","DB_COLLECTION","mongoose","connection","on","bind","once","generateJWT","refreshTokens","refreshToken","User","Object","assign","save","tk","d","find","update","n","DB_BCRYPT_SALT_ROUNDS","Schema","ObjectId","userSchema","type","String","unique","required","password","first","last","role","default","plugin","pre","bcrypt","hash","model","JWT_KEY","JWT_ACC_TIME","JWT_REF_TIME","bluebird","promisifyAll","accessToken","jwt","sign","expiresIn","tokens","decode","exp","token","verifyAsync"],"mappings":"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","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 2);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 24b2f2760a0224e3ff9a","module.exports = require(\"dotenv\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"dotenv\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"mongoose\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"mongoose\"\n// module id = 1\n// module chunks = 0","import env from 'dotenv'\r\nenv.config()\r\nconst { APP_PORT } = process.env\r\n\r\nimport Koa from 'koa'\r\nimport logger from 'koa-morgan'\r\nimport helmet from 'koa-helmet'\r\nimport bodyParser from 'koa-bodyparser'\r\n\r\nconst app = new Koa()\r\n\r\nimport router from './router'\r\n\r\n\r\napp\r\n  .use(bodyParser({\r\n    extendTypes: {\r\n      json: ['application/json']\r\n    },\r\n    onerror(err, ctx) {\r\n      console.error('body parse error', err, ctx.request.body);\r\n      ctx.throw(422, 'body parse error');\r\n    }\r\n  }))\r\n  .use(router.routes())\r\n  .use(router.allowedMethods())\r\n  .use(helmet())\r\n  .use(logger('tiny'))\r\n  .listen(APP_PORT, () => {\r\n    console.log('APP START');\r\n  })\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"koa\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"koa-morgan\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa-morgan\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"koa-helmet\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa-helmet\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"koa-bodyparser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa-bodyparser\"\n// module id = 7\n// module chunks = 0","// Выносится в конфиги (или еще куда)\r\nconst service = {\r\n  name: 'API AuthVI',\r\n  version: '1.0.0',\r\n  msg: \"Hello Auth service\"\r\n  // Все о запрсе\r\n  // + еще инф.\r\n}\r\n\r\n\r\nimport env from 'dotenv'\r\nenv.config()\r\nconst { APP_MAIN_ROUTS_PREFIX } = process.env\r\n\r\nimport Router from 'koa-router'\r\n\r\nimport UC from './UserController'\r\nconst { UserSugnIn, UserSugnUp, TokenСheck } = UC\r\n\r\nconst router = new Router({\r\n  prefix: APP_MAIN_ROUTS_PREFIX\r\n})\r\n\r\n\r\n\r\nrouter\r\n  .get('/', (ctx, next) => {\r\n    ctx.status = 201\r\n    ctx.body = {\r\n      service\r\n    }\r\n  })\r\n  .post('/signin', UserSugnIn, (ctx, next) => {\r\n    \r\n  })\r\n  .post('/signup', UserSugnUp, (ctx, next) => {\r\n    let {user, JWT, errors} = ctx.user\r\n    console.log(errors);\r\n    \r\n    ctx.body = { service, user, JWT, errors} \r\n  })\r\n  .get('/test', TokenСheck, (ctx, next) => {\r\n\r\n  })\r\n\r\nexport default router\n\n\n// WEBPACK FOOTER //\n// ./src/router.js","module.exports = require(\"koa-router\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa-router\"\n// module id = 9\n// module chunks = 0","import env from 'dotenv'\r\nenv.config()\r\nconst { } = process.env\r\n\r\nimport db from './dbUtils'\r\ndb.connect()\r\nimport { CheckJWT, generateJWT } from './jwt'\r\n\r\nexport default {\r\n  async UserSugnIn(ctx, next) {\r\n    console.log('UserSugnIn');\r\n    ctx.status = 200\r\n\r\n    next()\r\n  },\r\n  async UserSugnUp(ctx, next) {\r\n    ctx.status = 401\r\n    let result = await db.addUser(ctx.request.body)\r\n\r\n    if (!result) {\r\n      ctx.status = 400\r\n    }\r\n    if (result.errors) {\r\n      ctx.user = result\r\n    }\r\n    if (!result.errors && result) {\r\n      ctx.status = 201\r\n      ctx.user = result\r\n    }\r\n\r\n    next()\r\n  },\r\n  async TokenСheck(ctx, next) {\r\n    ctx.status = 403\r\n    ctx.body = 'token not falid'\r\n\r\n\r\n    let { authorization } = ctx.headers\r\n    if (!authorization || !authorization.match(/^Bearer\\s/)) return\r\n    let Token = authorization.replace(/^Bearer\\s/, '')\r\n\r\n    if (ctx.query.refresh) {\r\n      let newJWT = await db.refreshUserToken(Token)\r\n      ctx.body = { newJWT, msg: \"Все ок\" }\r\n      // let { accessToken } = newJWT\r\n      // console.log(newJWT);\r\n      // let { login } = await CheckJWT(accessTokenr)\r\n      // if (login) {\r\n      //   ctx.body = { login, msg: \"Все ок\" }\r\n      // }\r\n      return\r\n    }\r\n\r\n    let { login } = await CheckJWT(Token)\r\n    if (login) {\r\n      ctx.body = { login, msg: \"Все ок\" }\r\n    }\r\n  }\r\n}\n\n\n// WEBPACK FOOTER //\n// ./src/UserController/index.js","import env from 'dotenv'\r\nenv.config()\r\nconst { DB_HOST, DB_PORT, DB_COLLECTION } = process.env\r\n\r\nimport mongoose from 'mongoose'\r\nimport User from './UserSchema'\r\nimport { generateJWT, CheckJWT } from './jwt'\r\n\r\n\r\n\r\nconst db = {\r\n  connect() {\r\n    mongoose.connect(`mongodb://${DB_HOST}:${DB_PORT}/${DB_COLLECTION}`);\r\n    let db = mongoose.connection;\r\n    db.on('error', console.error.bind(console, 'connection error:'));\r\n    db.once('open', function () {\r\n      console.log('DB START');\r\n    });\r\n  },\r\n\r\n  async addUser(body) {\r\n    let JWT = await generateJWT(body.login)\r\n    try {\r\n      let refreshTokens = { refreshTokens: JWT.refreshToken }\r\n      let user = await User(Object.assign(body, refreshTokens)).save()\r\n\r\n      return { user, JWT }\r\n    } catch (error) {\r\n      return error\r\n    }\r\n  },\r\n\r\n\r\n\r\n\r\n  async refreshUserToken(tk) {\r\n    try {\r\n      let newJWT = await generateJWT( CheckJWT(tk).login )\r\n      \r\n      let d = await User.find({refreshTokens: [tk]}).update({refreshTokens: [newJWT.refreshToken]})\r\n      if (d.n) {\r\n        return newJWT\r\n      }\r\n    } catch (error) {\r\n      console.log(error);\r\n      return error\r\n    }\r\n\r\n\r\n  }\r\n}\r\n\r\n\r\nexport default db\n\n\n// WEBPACK FOOTER //\n// ./src/UserController/dbUtils.js","import env from 'dotenv'\r\nenv.config()\r\nconst { DB_BCRYPT_SALT_ROUNDS } = process.env\r\n\r\nimport bcrypt from 'bcrypt'\r\nimport mongoose from 'mongoose';\r\nimport uniquePlagin from 'mongoose-beautiful-unique-validation'\r\nconst Schema = mongoose.Schema;\r\nconst ObjectId = Schema.ObjectId;\r\n\r\nconst userSchema = new Schema({\r\n  login: {\r\n    type: String,\r\n    unique: true,\r\n    required: true\r\n  },\r\n  password: {\r\n    type: String,\r\n    required: true\r\n  },\r\n  name: {\r\n    first: String,\r\n    last: String\r\n  },\r\n  role: {\r\n    type: String,\r\n    required: true,\r\n    default: 'user'\r\n  },\r\n  refreshTokens: [String]\r\n});\r\nuserSchema.plugin(uniquePlagin)\r\nuserSchema.pre('save', function (next) {\r\n  var user = this;\r\n  bcrypt.hash(user.password, 10, function (err, hash){\r\n    if (err) return next(err)\r\n    user.password = hash;\r\n    next();\r\n  })\r\n});\r\n\r\n\r\nconst User = mongoose.model('User', userSchema);\r\nexport default User;\n\n\n// WEBPACK FOOTER //\n// ./src/UserController/UserSchema.js","module.exports = require(\"bcrypt\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bcrypt\"\n// module id = 13\n// module chunks = 0","module.exports = require(\"mongoose-beautiful-unique-validation\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"mongoose-beautiful-unique-validation\"\n// module id = 14\n// module chunks = 0","import env from 'dotenv'\r\nenv.config()\r\nconst { JWT_KEY, JWT_ACC_TIME, JWT_REF_TIME } = process.env\r\n\r\nimport jwt from 'jsonwebtoken'\r\nimport bluebird from 'bluebird'\r\n\r\nbluebird.promisifyAll(jwt)\r\n\r\n\r\nasync function generateJWT(login) {\r\n  const accessToken = jwt.sign({ login }, JWT_KEY, { expiresIn: JWT_ACC_TIME })\r\n  const refreshToken = jwt.sign({ login }, JWT_KEY, { expiresIn: JWT_REF_TIME })\r\n  const tokens = {\r\n    accessToken,\r\n    refreshToken,\r\n    expiresIn: jwt.decode(accessToken).exp,\r\n  }\r\n\r\n  return tokens\r\n}\r\n\r\nasync function CheckJWT(token) {\r\n  try {\r\n    const result = await jwt.verifyAsync(token, JWT_KEY)\r\n    return result\r\n  } catch (error) {\r\n    console.log('Cannot verify token:', token)\r\n  }\r\n\r\n  return {}\r\n}\r\n\r\nexport { generateJWT, CheckJWT }\n\n\n// WEBPACK FOOTER //\n// ./src/UserController/jwt.js","module.exports = require(\"jsonwebtoken\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jsonwebtoken\"\n// module id = 16\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 17\n// module chunks = 0"],"sourceRoot":""}